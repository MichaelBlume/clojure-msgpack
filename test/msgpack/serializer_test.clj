(ns msgpack.serializer-test
  (:require [clojure.test :refer :all]
            [msgpack.utils :refer :all]
            [msgpack.serializer :refer :all]))

(defn- serializes-as [thing bseq]
  (is (= (unsigned-bytes bseq) (serialize thing))))

(deftest nil-test
  (testing "nil"
    (serializes-as nil [0xc0])))

(deftest boolean-test
  (testing "booleans"
    (serializes-as false [0xc2])
    (serializes-as true [0xc3])))

(deftest int-test
  (testing "positive fixnum"
    (serializes-as 0 [0x00])
    (serializes-as 0x10 [0x10])
    (serializes-as 0x7f [0x7f]))
  (testing "negative fixnum"
    (serializes-as -1 [0xff])
    (serializes-as -16 [0xf0])
    (serializes-as -32 [0xe0]))
  (testing "uint 8"
    (serializes-as 0x80 [0xcc 0x80])
    (serializes-as 0xf0 [0xcc 0xf0])
    (serializes-as 0xff [0xcc 0xff]))
  (testing "uint 16"
    (serializes-as 0x100 [0xcd 0x01 0x00])
    (serializes-as 0x2000 [0xcd 0x20 0x00])
    (serializes-as 0xffff [0xcd 0xff 0xff]))
  (testing "uint 32"
    (serializes-as 0x10000 [0xce 0x00 0x01 0x00 0x00])
    (serializes-as 0x200000 [0xce 0x00 0x20 0x00 0x00])
    (serializes-as 0xffffffff [0xce 0xff 0xff 0xff 0xff]))
  (testing "uint 64"
    (serializes-as 0x100000000 [0xcf 0x00 0x00 0x00 0x01 0x00 0x00 0x00 0x00])
    (serializes-as 0x200000000000 [0xcf 0x00 0x00 0x20 0x00 0x00 0x00 0x00 0x00])
    (serializes-as 0xffffffffffffffff [0xcf 0xff 0xff 0xff 0xff 0xff 0xff 0xff 0xff]))
  (testing "int 8"
    (serializes-as -33 [0xd0 0xdf])
    (serializes-as -100 [0xd0 0x9c])
    (serializes-as -128 [0xd0 0x80]))
  (testing "int 16"
    (serializes-as -129 [0xd1 0xff 0x7f])
    (serializes-as -2000 [0xd1 0xf8 0x30])
    (serializes-as -32768 [0xd1 0x80 0x00]))
  (testing "int 32"
    (serializes-as -32769 [0xd2 0xff 0xff 0x7f 0xff])
    (serializes-as -1000000000 [0xd2 0xc4 0x65 0x36 0x00])
    (serializes-as -2147483648 [0xd2 0x80 0x00 0x00 0x00]))
  (testing "int 64"
    (serializes-as -2147483649 [0xd3 0xff 0xff 0xff 0xff 0x7f 0xff 0xff 0xff])
    (serializes-as -1000000000000000002 [0xd3 0xf2 0x1f 0x49 0x4c 0x58 0x9b 0xff 0xfe])
    (serializes-as -9223372036854775808 [0xd3 0x80 0x00 0x00 0x00 0x00 0x00 0x00 0x00])))

(deftest float-test
  (testing "float 32"
    (serializes-as (float 0.0) [0xca 0x00 0x00 0x00 0x00])
    (serializes-as (float 2.5) [0xca 0x40 0x20 0x00 0x00]))
  (testing "float 64"
    (serializes-as 0.0 [0xcb 0x00 0x00 0x00 0x00 0x00 0x00 0x00 0x00])
    (serializes-as 2.5 [0xcb 0x40 0x04 0x00 0x00 0x00 0x00 0x00 0x00])
    (serializes-as (Math/pow 10 35) [0xcb 0x47 0x33 0x42 0x61 0x72 0xc7 0x4d 0x82])))

(deftest str-test
  (testing "fixstr"
    (serializes-as "hello world" [0xab 0x68 0x65 0x6c 0x6c 0x6f 0x20 0x77 0x6f 0x72 0x6c 0x64])))
